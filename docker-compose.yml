# =============================================================================
# Docker Compose - Local Development
# =============================================================================
# Mirrors production as closely as possible to catch environment bugs early.
#
# Key parity points:
#   - Same image versions as docker-compose.production.yml
#   - Same healthchecks on every service (app + infra)
#   - JSON-file logging with rotation (prevents log bloat)
#   - DOCKER_ENV=true so logger.js skips pino-roll file rotation
#   - NEXT_PUBLIC_WS_URL build arg set (was absent, broke WebSocket locally)
#   - Qdrant GRPC port env matches production
#
# Intentional local-only differences:
#   - Backend source code mounted (./backend:/app) for hot-reload
#   - Ports exposed on 0.0.0.0 (not loopback-only) for easy host access
#   - Redis has no password (REDIS_URL stays simple)
#   - MongoDB runs as a container (production uses Atlas)
#   - NODE_ENV=development (enables pino-pretty console logs)
#   - No resource limits (avoid throttling dev machines)
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose up -d backend      # Start only backend
#   docker compose logs -f backend    # Follow backend logs
#   docker compose down -v            # Stop and remove volumes
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Frontend (Next.js)
  # ===========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://localhost:3007/api/v1
        - NEXT_PUBLIC_WS_URL=http://localhost:3007
        - NEXT_PUBLIC_APP_NAME=Retrieva
    container_name: rag-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - rag-network
    restart: unless-stopped

  # ===========================================================================
  # Backend Service (Node.js/Express)
  # ===========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rag-backend
    ports:
      - "3007:3007"
    env_file:
      - ./backend/.env
    environment:
      - NODE_ENV=development
      - DOCKER_ENV=true
      - PORT=3007
      - MONGODB_URI=mongodb://mongodb:27017/enterprise_rag
      - REDIS_URL=redis://redis:6379
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3007/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - rag-network
    restart: unless-stopped

  # ===========================================================================
  # MongoDB Database
  # ===========================================================================
  mongodb:
    image: mongodb/mongodb-community-server:7.0-ubuntu2204
    container_name: rag-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGODB_INITDB_DATABASE=enterprise_rag
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand({ping:1})"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - rag-network
    restart: unless-stopped

  # ===========================================================================
  # Redis (Caching & BullMQ)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: rag-redis
    ports:
      - "6378:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - rag-network
    restart: unless-stopped

  # ===========================================================================
  # Qdrant Vector Database
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:v1.13.2
    container_name: rag-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD-SHELL", "bash -c ':>/dev/tcp/0.0.0.0/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - rag-network
    restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================
networks:
  rag-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mongodb_data:
  redis_data:
  qdrant_data:
